<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Evcil Dost ‚Ä¢ Geli≈ümi≈ü v4</title>
<style>
:root{
  --bg1:#bfe7ff; --bg2:#f7fdff; --card:#ffffffee; --ink:#0f172a;
  --accent:#6366f1; --coin:#f4b400;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  display:grid; place-items:center; color:var(--ink);
}
#wrapper{
  width:min(94vw,980px); height:min(96vh,1100px);
  background:#eaf6ff; border-radius:22px; border:1px solid #d3e5ff;
  box-shadow:0 18px 70px rgba(0,0,0,.25);
  position:relative; overflow:hidden; display:flex; flex-direction:column;
}
.sky{
  position:absolute; inset:0; pointer-events:none; z-index:0;
  background:radial-gradient(120% 60% at 50% -10%, #ffffff 0%, #eaf6ff 55%, #d9eeff 100%);
}
.cloud{position:absolute; top:10%; width:180px; height:70px; background:#fff8; border-radius:40px; filter:blur(1px); animation:drift 40s linear infinite;}
.cloud.c2{top:30%; left:60%; width:240px; animation-duration:52s; opacity:.7;}
.cloud.c3{top:65%; left:10%; width:220px; animation-duration:48s; opacity:.6;}
@keyframes drift{from{transform:translateX(-40%)}to{transform:translateX(130%)}}

.hud{
  position:relative; z-index:2;
  display:flex; justify-content:space-between; align-items:center;
  padding:10px;
}
.pill{
  background:var(--card); border-radius:999px; border:1px solid #cfd8ff;
  padding:6px 10px; display:flex; gap:8px; align-items:center; font-weight:700;
}
.coin{display:inline-flex; align-items:center; gap:4px;}
.coin::before{content:"‚¶ø"; color:var(--coin);}
.link{
  all:unset; cursor:pointer; font-weight:800; border-bottom:2px solid #cfd8ff;
  font-size:.9rem;
}
#gear{cursor:pointer;}

#tabs{
  position:relative; z-index:2;
  display:grid; grid-template-columns:repeat(4,1fr); gap:6px;
  padding:0 8px 8px;
}
.tabbtn{
  all:unset; cursor:pointer; text-align:center; padding:.5rem .4rem;
  border-radius:12px; background:var(--card); border:1px solid #cfd8ff; font-weight:800;
}
.tabbtn.active{outline:2px solid var(--accent); outline-offset:2px;}

#screens{
  position:relative; z-index:1; flex:1; padding:0 8px 8px;
  display:grid; overflow:hidden;
}
.screen{
  display:none; background:var(--card); border-radius:14px; border:1px solid #cfe3ff;
  padding:10px; overflow:auto;
}
.screen.active{display:block;}

#stage{
  position:relative; border-radius:14px;
  background:linear-gradient(180deg,#e9f6ff 60%, #c8f7d4 60% 100%);
  border:1px dashed #cfe3ff;
  min-height:220px; padding:10px; display:grid; place-items:center;
  margin-bottom:10px;
}
#petFaceWrap{position:relative; display:inline-block;}
#petFace{
  position:relative; display:inline-block; user-select:none; cursor:pointer;
  transform-origin:center bottom; filter:drop-shadow(0 4px 8px rgba(0,0,0,.3));
}
.breath{animation:breath 3s ease-in-out infinite;}
@keyframes breath{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-4px) scale(1.04)}}
.blink::after{
  content:""; position:absolute; left:15%; right:15%; top:42%;
  height:12%; background:rgba(0,0,0,.23); border-radius:999px; opacity:0;
  animation:blink 6s infinite;
}
@keyframes blink{0%,92%,100%{opacity:0}94%,96%{opacity:1}}

.anim-bounce{animation:act-bounce .7s ease;}
@keyframes act-bounce{
  0%{transform:translateY(0) scale(1)}
  30%{transform:translateY(-16px) scale(1.06)}
  60%{transform:translateY(0) scale(1)}
  80%{transform:translateY(-6px) scale(1.02)}
  100%{transform:translateY(0) scale(1)}
}
.anim-shake{animation:act-shake .5s ease;}
@keyframes act-shake{
  0%{transform:translateX(0)}
  20%{transform:translateX(-6px) rotate(-3deg)}
  40%{transform:translateX(6px) rotate(3deg)}
  60%{transform:translateX(-4px) rotate(-2deg)}
  80%{transform:translateX(3px) rotate(2deg)}
  100%{transform:translateX(0) rotate(0)}
}
.anim-run{animation:act-run .8s ease;}
@keyframes act-run{
  0%{transform:translateX(-8px)}
  25%{transform:translateX(8px)}
  50%{transform:translateX(-4px)}
  75%{transform:translateX(4px)}
  100%{transform:translateX(0)}
}
.anim-glow{animation:act-glow 1s ease;}
@keyframes act-glow{
  0%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}
  40%{filter:drop-shadow(0 0 18px rgba(255,255,255,.95))}
  100%{filter:drop-shadow(0 4px 8px rgba(0,0,0,.3))}
}
.anim-pop{animation:act-pop .6s ease;}
@keyframes act-pop{
  0%{transform:scale(1)}
  40%{transform:scale(1.15)}
  70%{transform:scale(0.96)}
  100%{transform:scale(1)}
}

#petOutfit{
  position:absolute; bottom:-4px; right:-10px; font-size:32px;
  filter:drop-shadow(0 2px 6px rgba(0,0,0,.35));
}

.bars{display:grid; gap:6px;}
.row{display:flex; justify-content:space-between; align-items:center;}
.small{font-size:.85rem; opacity:.8;}
.bar{
  height:10px; border-radius:999px; overflow:hidden;
  background:#edf2ff; border:1px solid #d9e2ff;
}
.fill{height:100%;}
.g{background:linear-gradient(90deg,#86efac,#22c55e);}
.y{background:linear-gradient(90deg,#fde68a,#f59e0b);}
.r{background:linear-gradient(90deg,#fca5a5,#ef4444);}

.grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:8px;}

.card{
  background:#fff; border-radius:14px; border:1px solid #dfe6ff;
  padding:8px 10px;
}
.card h4{margin:4px 0 6px;}
.muted{opacity:.75; font-size:.85rem;}

.pillbtn{
  all:unset; cursor:pointer; border-radius:999px;
  border:1px solid #cfd8ff; padding:.38rem .7rem;
  font-size:.8rem; font-weight:700; background:#fff;
}
/* YENƒ∞: Devre dƒ±≈üƒ± buton stili */
.pillbtn:disabled{
  background:#f1f5f9; color:#64748b; border-color:#cbd5e1; cursor:not-allowed;
}

.activityList{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;}
.activityList button{font-size:.78rem;}

.sectionTitle{font-weight:700; margin:6px 0 2px;}

.invGrid{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:8px;}
.item{background:#f9fbff; border-radius:12px; border:1px solid #e3ecff; padding:8px; text-align:center;}
.item b{display:block; margin-bottom:2px;}

/* Modal */
#modalOverlay{
  position:absolute; inset:0; background:rgba(0,0,0,.45);
  display:none; place-items:center; z-index:20;
}
.modal{
  background:#0e101a; color:#e9eeff; border-radius:16px; border:1px solid #2a3358;
  padding:14px; width:min(92vw,540px);
}
.modal h3{margin:0 0 8px;}
.mrow{display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;}
.mbtn, select, input[type="text"]{
  all:unset; cursor:pointer; border-radius:10px; border:1px solid #3a4780;
  padding:.45rem .7rem; font-size:.9rem; font-weight:700; background:#11172a; color:#e9eeff;
}
.choice{display:grid; grid-template-columns:repeat(auto-fit,minmax(90px,1fr)); gap:8px; margin-top:6px;}
.opt{
  background:#0b0f1d; border-radius:10px; border:1px solid #2a3358;
  padding:6px; text-align:center; cursor:pointer;
}
.opt.active{outline:2px solid #7c83ff;}
.opt .emo{font-size:32px; display:block; margin-bottom:2px;}

#centerMsg{
  position:absolute; inset:0; display:grid; place-items:center;
  pointer-events:none; font-weight:800; font-size:18px;
  opacity:0; transition:opacity .25s; z-index:15;
}

/* Mini oyun overlay */
#gameOverlay{
  position:absolute; inset:0; background:rgba(0,0,0,.7);
  display:none; flex-direction:column; align-items:center; justify-content:center;
  z-index:25; color:#e9eeff; text-align:center; padding:10px;
}
.gameBox{
  background:#0e101a; border-radius:16px; border:1px solid #2a3358;
  padding:14px; width:min(92vw,480px);
}
.gameTarget{
  position:relative; width:100%; height:200px;
  background:#020617; border-radius:12px; margin-top:8px; overflow:hidden;
}
.gameDot{
  position:absolute; width:40px; height:40px; border-radius:999px;
  background:#22c55e; display:grid; place-items:center; font-size:18px;
}
.gameBarOuter{
  height:18px; border-radius:999px; background:#020617;
  border:1px solid #3a4780; overflow:hidden; margin-top:6px;
}
.gameBarInner{height:100%; width:0; background:linear-gradient(90deg,#22c55e,#fbbf24,#ef4444);}

.cooldown{
  font-size:.8rem; opacity:.8; margin-top:4px;
}

/* Hafƒ±za oyunu kartlarƒ± */
.memGrid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
  margin-top:8px;
}
.memCard{
  background:#020617;
  border-radius:10px;
  border:1px solid #334155;
  height:60px;
  display:grid;
  place-items:center;
  font-size:26px;
  cursor:pointer;
  user-select:none;
}
.memCard.revealed{
  background:#111827;
}
.memCard.matched{
  background:#16a34a;
  border-color:#4ade80;
}

/* YENƒ∞: Sƒ±ralƒ± Tƒ±kla Oyunu */
.seqGrid{
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:8px; margin-top:8px;
}
.seqBtn{
  all:unset; height:70px; background:#020617; border:1px solid #334155;
  border-radius:12px; cursor:pointer; font-size:24px; color:#fff;
  display:grid; place-items:center; transition:background .1s, transform .1s;
}
.seqBtn.lit{ background:#3b82f6; transform:scale(1.05); }
.seqBtn:active{ transform:scale(0.95); }
.seqBtn.disabled{ background:#374151; cursor:not-allowed; }
</style>
</head>
<body>
<div id="wrapper">
  <div class="sky">
    <div class="cloud"></div><div class="cloud c2"></div><div class="cloud c3"></div>
  </div>

  <div class="hud">
    <div class="pill">
      <span id="petName">Dost</span> ¬∑ <span id="petMeta">Seviye 1 ‚Ä¢ Minik</span>
      <button id="btnChangePet" class="link">Deƒüi≈ütir</button>
    </div>
    <div class="pill coin"><span id="coins">0</span></div>
    <div class="pill" id="gear">‚öôÔ∏è</div>
  </div>

  <div id="tabs">
    <button class="tabbtn active" data-tab="home">Evcil</button>
    <button class="tabbtn" data-tab="games">Oyunlar</button>
    <button class="tabbtn" data-tab="inventory">Envanter</button>
    <button class="tabbtn" data-tab="shop">Market</button>
  </div>

  <div id="screens">
    <div id="home" class="screen active">
      <div id="stage">
        <div id="petFaceWrap">
          <div id="petFace" class="breath blink"></div>
          <div id="petOutfit"></div>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <div class="bars">
            <div class="row small"><span>A√ßlƒ±k</span><span id="txtHunger"></span></div>
            <div class="bar"><div id="barHunger" class="fill g"></div></div>
            <div class="row small"><span>Ne≈üe</span><span id="txtFun"></span></div>
            <div class="bar"><div id="barFun" class="fill g"></div></div>
            <div class="row small"><span>Temizlik</span><span id="txtClean"></span></div>
            <div class="bar"><div id="barClean" class="fill g"></div></div>
            <div class="row small"><span>Enerji</span><span id="txtEnergy"></span></div>
            <div class="bar"><div id="barEnergy" class="fill g"></div></div>
            <div class="row small"><span>Baƒü</span><span id="txtBond"></span></div>
            <div class="bar"><div id="barBond" class="fill g"></div></div>
          </div>
        </div>
        <div class="card">
          <h4>Aktiviteler (Cooldown)</h4>
          <div id="activityList" class="activityList"></div>
        </div>
      </div>
    </div>

    <div id="games" class="screen">
      <h3>üéÆ Mini Oyunlar (Cooldown)</h3>
      <div id="gameList" class="grid"></div>
    </div>

    <div id="inventory" class="screen">
      <h3>üéí Envanter</h3>
      <div class="sectionTitle">Yemekler</div>
      <div id="invFood" class="invGrid"></div>
      <div class="sectionTitle" style="margin-top:8px;">Kƒ±yafetler</div>
      <div id="invOutfits" class="invGrid"></div>
    </div>

    <div id="shop" class="screen">
      <h3>üõí Market</h3>
      <div class="sectionTitle">Yemek</div>
      <div id="shopFood" class="invGrid"></div>
      <div class="sectionTitle" style="margin-top:8px;">Kƒ±yafetler (Se√ßili hayvana √∂zel)</div>
      <div id="shopOutfits" class="invGrid"></div>
    </div>
  </div>

  <div id="centerMsg"></div>

  <div id="modalOverlay"></div>

  <div id="gameOverlay">
    <div class="gameBox">
      <div class="mrow">
        <h3 id="gameTitle">Oyun</h3>
        <button class="mbtn" id="btnCloseGame">Kapat</button>
      </div>
      <div id="gameBody"></div>
    </div>
  </div>
</div>

<script>
(()=>{
  const SAVE_KEY="petGame_full_v4"; // S√ºr√ºm V4'e y√ºkseltildi
  const TICK_INTERVAL=15; // 15 saniyede bir ana stat d√º≈ü√º≈ü√º

  const SPECIES = {
    dog:     {name:"K√∂pek",  emo:["üê∂","üêï","üêï‚Äçf.lux.com/ü¶∫","üê∫"]},
    cat:     {name:"Kedi",   emo:["üê±","üêà","üêà‚Äç‚¨õ","ü¶Å"]},
    rabbit:  {name:"Tav≈üan", emo:["üêá","üê∞","üê∞","ü¶Ñ"]},
    fox:     {name:"Tilki",  emo:["ü¶ä","ü¶ä","ü¶ä","ü¶ä"]},
    panda:   {name:"Panda",  emo:["üêº","üêº","üêº","üêº"]},
    hamster: {name:"Hamster",emo:["üêπ","üêπ","üêπ","üêπ"]},
    bear:    {name:"Ayƒ±",    emo:["üß∏","üêª","üêª","üêª‚Äç‚ùÑÔ∏è"]},
    bird:    {name:"Ku≈ü",    emo:["üê£","üê§","üê¶","ü¶Ö"]}
  };
  const LEVEL_THRESH=[0,120,300,600,1000,1600,2500,4000];
  const STAGE_BY_LEVEL=[1,1,2,2,3,3,4,4];
  const SIZE_BY_STAGE={1:72,2:96,3:120,4:138};

  // YENƒ∞: Cooldown (saniye) eklendi
  const ACTIVITIES_COMMON = [
    {key:"pet",   label:"Sev",             anim:"bounce", stats:{bond:+6, fun:+4}, cooldown:120},
    {key:"snack", label:"Atƒ±≈ütƒ±rmalƒ±k",    anim:"pop",    stats:{hunger:+8, fun:+3, energy:+2}, cooldown:300},
    {key:"bath",  label:"Banyo",           anim:"glow",   stats:{clean:+18, fun:-2}, cooldown:240},
    {key:"nap",   label:"Kƒ±sa Uyku",       anim:"shake",  stats:{energy:+16, fun:-3}, cooldown:360},
    {key:"talk",  label:"Sohbet Et",       anim:"glow",   stats:{bond:+7, fun:+4}, cooldown:180}
  ];
  // YENƒ∞: Cooldown (saniye) ve 1 yeni aktivite eklendi
  const ACTIVITIES_SPECIES = {
    dog:[
      {key:"fetch", label:"Top Getir",     anim:"run",   stats:{fun:+10, energy:-6, bond:+4}, cooldown:150},
      {key:"park",  label:"Park Ko≈üusu",   anim:"run",   stats:{fun:+9, energy:-9, hunger:+4}, cooldown:240},
      {key:"trick", label:"Numara √ñƒüret",  anim:"glow",  stats:{bond:+8, fun:+5, energy:-4}, cooldown:180},
      {key:"lazy",  label:"Tembellik",     anim:"shake", stats:{energy:+10, fun:-2}, cooldown:300}
    ],
    cat:[
      {key:"laser", label:"Lazer Oyna",    anim:"run",   stats:{fun:+10, energy:-5}, cooldown:150},
      {key:"box",   label:"Kutu Keyfi",    anim:"bounce",stats:{fun:+7, bond:+3}, cooldown:180},
      {key:"climb", label:"Tƒ±rman",        anim:"shake", stats:{energy:-6, fun:+5, clean:-2}, cooldown:200},
      {key:"window",label:"Pencere Keyfi", anim:"glow",  stats:{fun:+8, bond:+2}, cooldown:240}
    ],
    rabbit:[
      {key:"carrot", label:"Havu√ß Ziyafeti", anim:"pop",  stats:{hunger:+14, fun:+4, clean:-3}, cooldown:300},
      {key:"hop",    label:"Zƒ±pla Zƒ±pla",    anim:"bounce",stats:{fun:+8, energy:-6}, cooldown:150},
      {key:"burrow", label:"T√ºnel Kaz",      anim:"run",   stats:{fun:+5, clean:-3, energy:-4}, cooldown:180},
      {key:"groom",  label:"T√ºy Temizle",    anim:"glow",  stats:{clean:+12, bond:+2}, cooldown:240}
    ],
    fox:[
      {key:"stealth", label:"Gizli Gezinti", anim:"shake", stats:{fun:+8, bond:+3}, cooldown:180},
      {key:"chase",   label:"Kovalamaca",    anim:"run",   stats:{fun:+9, energy:-7}, cooldown:150},
      {key:"spin",    label:"D√∂nme Hareketi",anim:"pop",   stats:{fun:+6}, cooldown:120},
      {key:"explore", label:"Ke≈üif",         anim:"run",   stats:{fun:+7, energy:-5, bond:+3}, cooldown:240}
    ],
    panda:[
      {key:"bamboo",  label:"Bambu Ziyafeti",anim:"pop",   stats:{hunger:+16, fun:+4, clean:-4}, cooldown:300},
      {key:"roll",    label:"Yuvarlanma",    anim:"bounce",stats:{fun:+9}, cooldown:150},
      {key:"chill",   label:"Rahatlama",     anim:"glow",  stats:{bond:+5, energy:+4}, cooldown:180},
      {key:"meditate",label:"Meditasyon",    anim:"glow",  stats:{bond:+8, energy:+5}, cooldown:300}
    ],
    hamster:[
      {key:"wheel",   label:"Tekerlek Ko≈üusu",anim:"run",  stats:{energy:-10, fun:+8}, cooldown:150},
      {key:"stash",   label:"Yiyecek Sakla",  anim:"pop",  stats:{bond:+3, fun:+4}, cooldown:180},
      {key:"groom",   label:"T√ºy Bakƒ±mƒ±",     anim:"glow", stats:{clean:+10, bond:+3}, cooldown:240},
      {key:"maze",    label:"Labirent",       anim:"run",  stats:{fun:+9, energy:-6}, cooldown:200}
    ],
    bear:[
      {key:"fish",  label:"Balƒ±k Avƒ±",     anim:"run",   stats:{hunger:+14, fun:+5, energy:-6, clean:-3}, cooldown:300},
      {key:"roar",  label:"K√ºkreme",       anim:"shake", stats:{bond:+3, fun:+4}, cooldown:120},
      {key:"forest",label:"Orman Y√ºr√ºy√º≈ü√º",anim:"run",   stats:{fun:+7, energy:-6}, cooldown:200},
      {key:"honey", label:"Bal Ziyafeti",  anim:"pop",   stats:{hunger:+12, fun:+6, clean:-4}, cooldown:240}
    ],
    bird:[
      {key:"fly",   label:"U√ßu≈ü",          anim:"run",   stats:{fun:+9, energy:-8}, cooldown:150},
      {key:"sing",  label:"≈ûarkƒ± S√∂yle",   anim:"glow",  stats:{bond:+6, fun:+7}, cooldown:180},
      {key:"perch", label:"Dal Keyfi",     anim:"bounce",stats:{fun:+4, energy:+3}, cooldown:120},
      {key:"preen", label:"T√ºy D√ºzeltme",  anim:"glow",  stats:{clean:+12, bond:+3}, cooldown:240}
    ]
  };

  const FOODS = [
    {id:"food_dry",    name:"Kuru Mama üçò",                hunger:+18, fun:+2, clean:-2, energy:+2, price:8},
    {id:"food_meat",   name:"Et/Tavuk üçó",                 hunger:+26, fun:+4, clean:-3, energy:+4, price:15, pref:"dog"},
    {id:"food_fish",   name:"Balƒ±k üêü",                    hunger:+26, fun:+4, clean:-3, energy:+4, price:15, pref:"cat"},
    {id:"food_energy", name:"Enerji Atƒ±≈ütƒ±rmalƒ±ƒüƒ± ‚ö°",      hunger:+8,  fun:+2, clean:0,  energy:+18,price:14}
  ];

  // YENƒ∞: Her t√ºre 1 yeni kƒ±yafet eklendi
  const OUTFITS = {
    dog:[
      {id:"dog_bandana", label:"Kƒ±rmƒ±zƒ± Bandana üß£", emoji:"üß£", price:30},
      {id:"dog_hat",     label:"≈ûapka üß¢",          emoji:"üß¢", price:40},
      {id:"dog_glasses", label:"G√ºne≈ü G√∂zl√ºƒü√º üï∂Ô∏è", emoji:"üï∂Ô∏è", price:45},
      {id:"dog_bone",    label:"Altƒ±n Kemik ü¶¥",   emoji:"ü¶¥", price:55}
    ],
    cat:[
      {id:"cat_collar",  label:"Zilli Tasma üîî",   emoji:"üîî", price:30},
      {id:"cat_bow",     label:"Pembe Fiyonk üéÄ",  emoji:"üéÄ", price:40},
      {id:"cat_crown",   label:"Mini Ta√ß üëë",      emoji:"üëë", price:50},
      {id:"cat_yarn",    label:"Y√ºn Yumak üß∂",     emoji:"üß∂", price:35}
    ],
    rabbit:[
      {id:"rab_flower",  label:"√ái√ßek Ta√ß üå∏",     emoji:"üå∏", price:35},
      {id:"rab_scarf",   label:"Mini Atkƒ± üß£",     emoji:"üß£", price:30},
      {id:"rab_hood",    label:"Kulaklƒ± Kap≈üon üê∞",emoji:"üß•", price:45},
      {id:"rab_carrot",  label:"Havu√ß Kolye ü•ï",   emoji:"ü•ï", price:38}
    ],
    fox:[
      {id:"fox_cape",    label:"Kƒ±rmƒ±zƒ± Pelerin üß•",emoji:"üß•", price:45},
      {id:"fox_mask",    label:"Maske üé≠",          emoji:"üé≠", price:38},
      {id:"fox_band",    label:"Ba≈ü Bandƒ± ü©π",      emoji:"ü©π", price:30},
      {id:"fox_fire",    label:"Alev Efekti üî•",   emoji:"üî•", price:50}
    ],
    panda:[
      {id:"pan_headband",label:"Bant ü©π",           emoji:"ü©π", price:30},
      {id:"pan_jacket",  label:"Mont üß•",           emoji:"üß•", price:45},
      {id:"pan_star",    label:"Yƒ±ldƒ±z Rozet ‚≠ê",   emoji:"‚≠ê", price:35},
      {id:"pan_bamboo",  label:"Bambu Sƒ±rƒ±k üéã",   emoji:"üéã", price:40}
    ],
    hamster:[
      {id:"ham_hood",    label:"Kap≈üonlu üê≠",      emoji:"üß•", price:30},
      {id:"ham_glasses", label:"G√∂zl√ºk üëì",        emoji:"üëì", price:35},
      {id:"ham_hat",     label:"Mini ≈ûapka üé©",    emoji:"üé©", price:32},
      {id:"ham_seed",    label:"√áekirdek üå∞",      emoji:"üå∞", price:38}
    ],
    bear:[
      {id:"bear_hat",    label:"Kƒ±≈ü ≈ûapkasƒ± üé©",    emoji:"üé©", price:40},
      {id:"bear_scarf",  label:"Kalƒ±n Atkƒ± üß£",     emoji:"üß£", price:35},
      {id:"bear_badge",  label:"Orman Rozeti üå≤",   emoji:"üå≤", price:38},
      {id:"bear_honey",  label:"Bal Kavanozu üçØ",   emoji:"üçØ", price:42}
    ],
    bird:[
      {id:"bird_crown",  label:"Mini Ta√ß üëë",      emoji:"üëë", price:45},
      {id:"bird_ribbon", label:"Ku≈ü Kurdele üéÄ",   emoji:"üéÄ", price:35},
      {id:"bird_star",   label:"Parlak Yƒ±ldƒ±z ‚≠ê",  emoji:"‚≠ê", price:32},
      {id:"bird_note",   label:"M√ºzik Notasƒ± üéµ",  emoji:"üéµ", price:38}
    ]
  };

  // YENƒ∞: 1 yeni oyun eklendi, 3 oyun zorla≈ütƒ±rƒ±ldƒ±
  const GAMES = [
    { key:"reflex",  name:"‚ö° Refleks Tƒ±kla", desc:"(Zor) 8 sn boyunca ye≈üil noktaya tƒ±kla.", cooldown:60 },
    { key:"timing",  name:"üéØ Zamanlama",    desc:"(Zor) Bar %100'e en yakƒ±n anda durdur.",  cooldown:75 },
    { key:"balloon", name:"üéà Balon Patlat", desc:"(Zor) Yukarƒ± √ßƒ±kan balonlarƒ± tƒ±kla.",     cooldown:70 },
    { key:"memory",  name:"üß† Hafƒ±za Kartlarƒ±", desc:"E≈ü ikon √ßiftlerini bul.",        cooldown:80 },
    { key:"sequence",name:"üî¢ Sƒ±ralƒ± Tƒ±kla", desc:"Giderek uzayan sƒ±rayƒ± tekrar et.", cooldown:120 }
  ];

  let state = {
    name:"Dost",
    species:"dog",
    level:1, xp:0,
    hunger:80, fun:80, clean:80, energy:80, bond:40,
    coins:80,
    foods:{},
    outfits:{},
    equipped:{},
    gameCooldowns:{},
    activityCooldowns:{}, // YENƒ∞: Aktivite bekleme s√ºreleri
    slowMode:false,
    seenSelector:false,
    lastTick:Date.now()
  };

  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const barClass = v=> v>=60?"g":v>=30?"y":"r";

  function load(){
    const raw=localStorage.getItem(SAVE_KEY);
    if(raw){
      try{
        const saved=JSON.parse(raw);
        Object.assign(state,saved);
        if(typeof state.slowMode!=="boolean") state.slowMode=false;
        if(!state.activityCooldowns) state.activityCooldowns = {}; // Eski kayƒ±tlar i√ßin
      }catch(e){}
    }

    // YENƒ∞: √áevrimdƒ±≈üƒ± ilerleme hesaplamasƒ±
    const now = Date.now();
    const elapsed = (now - (state.lastTick || now)) / 1000; // Saniye cinsinden
    if(elapsed > 0){
      const ticksPassed = Math.floor(elapsed / TICK_INTERVAL);
      if(ticksPassed > 0){
        const factor = state.slowMode ? 0.4 : 1;
        const decayHunger = ticksPassed * 0.5 * factor;
        const decayFun = ticksPassed * 0.3 * factor;
        const gainEnergy = ticksPassed * 0.3 * factor;
        state.hunger = clamp(state.hunger - decayHunger, 0, 100);
        state.fun = clamp(state.fun - decayFun, 0, 100);
        state.energy = clamp(state.energy + gainEnergy, 0, 100);
        console.log(`√áevrimdƒ±≈üƒ±: ${ticksPassed} tik ge√ßti. ƒ∞statistikler g√ºncellendi.`);
      }
    }
    state.lastTick = now; // Her durumda son tick'i g√ºncelle
  }
  function save(){
    state.lastTick=Date.now();
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  }

  function stageIndex(){
    const idx=Math.min(STAGE_BY_LEVEL.length-1, Math.max(0,state.level-1));
    return STAGE_BY_LEVEL[idx];
  }
  function petEmoji(){
    const st=stageIndex();
    const arr=SPECIES[state.species]?.emo || SPECIES.dog.emo;
    return arr[st-1] || arr[arr.length-1];
  }

  function showToast(txt){
    const c=$("#centerMsg");
    c.textContent=txt;
    c.style.opacity=1;
    setTimeout(()=>c.style.opacity=0,1100);
  }

  function updateBars(){
    const set=(barId,val,txtId)=>{
      const el=$(barId);
      el.className="fill "+barClass(val);
      el.style.width=clamp(val,0,100)+"%";
      if(txtId) $(txtId).textContent=Math.round(val);
    };
    set("#barHunger",state.hunger,"#txtHunger");
    set("#barFun",state.fun,"#txtFun");
    set("#barClean",state.clean,"#txtClean");
    set("#barEnergy",state.energy,"#txtEnergy");
    set("#barBond",state.bond,"#txtBond");
  }

  function levelCheck(addXp=0){
    state.xp+=addXp;
    const need=LEVEL_THRESH[state.level]||Infinity;
    if(state.xp>=need && state.level<LEVEL_THRESH.length){
      state.level++;
      const pf=$("#petFace");
      pf.classList.add("anim-glow");
      setTimeout(()=>pf.classList.remove("anim-glow"),1000);
      showToast("Seviye "+state.level+"!");
    }
  }

  function renderPet(){
    $("#petName").textContent=state.name;
    const stName={1:"Minik",2:"Gen√ß",3:"Yeti≈ükin",4:"Efsane"}[stageIndex()] || "Minik";
    $("#petMeta").textContent="Seviye "+state.level+" ‚Ä¢ "+stName;
    const pf=$("#petFace");
    pf.textContent=petEmoji();
    pf.style.fontSize = SIZE_BY_STAGE[stageIndex()]+"px";
    const outfId = state.equipped[state.species];
    const outfData = (OUTFITS[state.species]||[]).find(o=>o.id===outfId);
    $("#petOutfit").textContent = outfData ? outfData.emoji : "";
  }

  // YENƒ∞: Aktivite listesini bekleme s√ºreleriyle render et
  function renderActivities(){
    const wrap=$("#activityList");
    wrap.innerHTML="";
    const list=[...ACTIVITIES_COMMON, ...(ACTIVITIES_SPECIES[state.species]||[])];
    const now=Date.now();
    
    list.forEach(act=>{
      const btn=document.createElement("button");
      btn.className="pillbtn";
      
      const until=state.activityCooldowns[act.key]||0;
      if(until > now){
        const secs=Math.ceil((until-now)/1000);
        btn.textContent=act.label + ` (${secs}s)`;
        btn.disabled=true;
      } else {
        btn.textContent=act.label;
        btn.onclick=()=>runActivity(act);
      }
      wrap.appendChild(btn);
    });
  }

  function speciesParticles(){
    switch(state.species){
      case "dog": return ["üêæ","üíñ","‚ú®"];
      case "cat": return ["üòº","üí´","‚ú®"];
      case "rabbit": return ["ü•ï","‚ú®","üíö"];
      case "fox": return ["ü¶ä","‚ú®","üî•"];
      case "panda": return ["üéã","üíñ","‚ú®"];
      case "hamster": return ["üå∞","üíõ","‚ú®"];
      case "bear": return ["üå≤","üíö","‚ú®"];
      case "bird": return ["üéµ","üïäÔ∏è","‚ú®"];
      default: return ["üíñ","‚ú®"];
    }
  }

  function playActivityAnimation(type){
    const pf=$("#petFace");
    const clsMap={bounce:"anim-bounce", shake:"anim-shake", run:"anim-run", glow:"anim-glow", pop:"anim-pop"};
    const cls=clsMap[type]||"anim-bounce";
    pf.classList.add(cls);
    setTimeout(()=>pf.classList.remove(cls),800);

    const wrap=$("#petFaceWrap");
    const set=speciesParticles();
    for(let i=0;i<8;i++){
      const span=document.createElement("span");
      span.textContent=set[Math.floor(Math.random()*set.length)];
      span.style.position="absolute";
      span.style.left="50%";
      span.style.top="40%";
      span.style.transform="translate(-50%,-50%)";
      span.style.transition="all 1s ease";
      span.style.pointerEvents="none";
      wrap.appendChild(span);
      const dx=(Math.random()*160-80);
      const dy=(Math.random()*-160-40);
      const sc=0.6+Math.random()*0.6;
      requestAnimationFrame(()=>{
        span.style.transform=`translate(${dx}px,${dy}px) scale(${sc})`;
        span.style.opacity="0";
      });
      setTimeout(()=>span.remove(),1000);
    }
  }

  // YENƒ∞: Aktiviteyi bekleme s√ºresiyle √ßalƒ±≈ütƒ±r
  function runActivity(act){
    // Cooldown kontrol√º (ekstra g√ºvenlik)
    const now = Date.now();
    const until = state.activityCooldowns[act.key] || 0;
    if(until > now){
      showToast("Bu aktivite i√ßin beklemelisiniz.");
      return;
    }
    
    playActivityAnimation(act.anim);
    const st=act.stats||{};
    state.hunger = clamp(state.hunger+(st.hunger||0),0,100);
    state.fun    = clamp(state.fun   +(st.fun   ||0),0,100);
    state.clean  = clamp(state.clean +(st.clean ||0),0,100);
    state.energy = clamp(state.energy+(st.energy||0),0,100);
    state.bond   = clamp(state.bond  +(st.bond  ||0),0,100);
    
    // Cooldown ayarla
    if(act.cooldown){
      state.activityCooldowns[act.key] = now + act.cooldown * 1000;
    }
    
    levelCheck(7);
    updateBars();
    renderActivities(); // Cooldown'u g√∂stermek i√ßin listeyi yenile
    save();
  }

  function renderInventory(){
    const invFood=$("#invFood");
    invFood.innerHTML="";
    let foodCount = 0;
    FOODS.forEach(f=>{
      const qty=state.foods[f.id]||0;
      if(qty<=0) return;
      foodCount++;
      const d=document.createElement("div");
      d.className="item";
      d.innerHTML=`<b>${f.name}</b><div class="muted">${qty} adet</div>`;
      const btn=document.createElement("button");
      btn.className="pillbtn";
      btn.textContent="Kullan";
      btn.onclick=()=>useFood(f);
      d.appendChild(btn);
      invFood.appendChild(d);
    });
    if(foodCount === 0){
      invFood.innerHTML="<div class='muted'>Hi√ß yemek yok.</div>";
    }

    const invOut=$("#invOutfits");
    invOut.innerHTML="";
    const ownedIds=state.outfits[state.species]||[];
    const eq=state.equipped[state.species];

    if(!ownedIds.length && !eq){
      invOut.innerHTML="<div class='muted'>Bu t√ºr i√ßin kƒ±yafet yok.</div>";
    } else {
        // YENƒ∞: Kƒ±yafet √áƒ±kar butonu
        if(eq){
            const d=document.createElement("div");
            d.className="item";
            d.innerHTML=`<b>Kƒ±yafet √áƒ±kar</b><div style="font-size:26px;margin-bottom:4px">üö´</div>`;
            const btn=document.createElement("button");
            btn.className="pillbtn";
            btn.textContent="√áƒ±kar";
            btn.onclick=()=>{
                delete state.equipped[state.species];
                save();
                renderPet();
                renderInventory();
            };
            d.appendChild(btn);
            invOut.appendChild(d);
        }

        ownedIds.forEach(id=>{
            const data=(OUTFITS[state.species]||[]).find(o=>o.id===id);
            if(!data) return;
            const d=document.createElement("div");
            d.className="item";
            d.innerHTML=`<b>${data.label}</b><div style="font-size:26px;margin-bottom:4px">${data.emoji}</div>`;
            const btn=document.createElement("button");
            btn.className="pillbtn";
            btn.textContent = eq===id ? "Takƒ±lƒ±" : "Giy";
            btn.disabled = eq===id;
            btn.onclick=()=>{
            state.equipped[state.species]=id;
            save();
            renderPet();
            renderInventory();
            };
            d.appendChild(btn);
            invOut.appendChild(d);
        });
    }
  }

  function useFood(f){
    const has=state.foods[f.id]||0;
    if(!has){ showToast("Bu yiyecek bitti."); return; }
    let mult=1;
    if(f.pref && ((f.pref==="dog"&&state.species==="dog")||(f.pref==="cat"&&state.species==="cat"))) mult=1.1;
    state.hunger = clamp(state.hunger + (f.hunger||0)*mult,0,100);
    state.fun    = clamp(state.fun    + (f.fun   ||0)*mult,0,100);
    state.clean  = clamp(state.clean  + (f.clean ||0)*mult,0,100);
    state.energy = clamp(state.energy + (f.energy||0)*mult,0,100);
    state.foods[f.id]=has-1;
    if(state.foods[f.id]<=0) delete state.foods[f.id];
    levelCheck(5);
    updateBars();
    renderInventory();
    save();
  }

  function renderShop(){
    const sFood=$("#shopFood");
    sFood.innerHTML="";
    FOODS.forEach(f=>{
      const d=document.createElement("div");
      d.className="item";
      d.innerHTML=`<b>${f.name}</b>
        <div class="muted" style="font-size:.8rem">
          A√ßlƒ±k ${(f.hunger>=0?"+":"")+f.hunger} ¬∑ Ne≈üe ${(f.fun>=0?"+":"")+f.fun}<br>
          Temizlik ${(f.clean>=0?"+":"")+f.clean} ¬∑ Enerji ${(f.energy>=0?"+":"")+f.energy}
        </div>
        <div class="muted" style="margin-top:4px">Fiyat: <span class="coin">${f.price}</span></div>`;
      const btn=document.createElement("button");
      btn.className="pillbtn";
      btn.textContent="Al";
      btn.onclick=()=>buyFood(f);
      d.appendChild(btn);
      sFood.appendChild(d);
    });

    const sOut=$("#shopOutfits");
    sOut.innerHTML="";
    const list=OUTFITS[state.species]||[];
    if(!list.length){
      sOut.innerHTML="<div class='muted'>Bu t√ºr i√ßin kƒ±yafet yok.</div>";
      return;
    }
    const owned = new Set(state.outfits[state.species]||[]);
    list.forEach(o=>{
      const d=document.createElement("div");
      d.className="item";
      d.innerHTML=`<b>${o.label}</b>
        <div style="font-size:28px;margin-bottom:4px">${o.emoji}</div>
        <div class="muted">Fiyat: <span class="coin">${o.price}</span></div>`;
      const btn=document.createElement("button");
      btn.className="pillbtn";
      if(owned.has(o.id)){
        btn.textContent="Sahip";
        btn.disabled=true;
      }else{
        btn.textContent="Satƒ±n al";
        btn.onclick=()=>buyOutfit(o);
      }
      d.appendChild(btn);
      sOut.appendChild(d);
    });
  }

  function buyFood(f){
    if(state.coins<f.price){ showToast("Yetersiz coin."); return; }
    state.coins-=f.price;
    state.foods[f.id]=(state.foods[f.id]||0)+1;
    $("#coins").textContent=state.coins;
    renderInventory();
    save();
  }

  function buyOutfit(o){
    if(state.coins<o.price){ showToast("Yetersiz coin."); return; }
    state.coins-=o.price;
    state.outfits[state.species]=state.outfits[state.species]||[];
    if(!state.outfits[state.species].includes(o.id)){
      state.outfits[state.species].push(o.id);
    }
    $("#coins").textContent=state.coins;
    renderInventory();
    renderShop();
    save();
  }

  function renderGames(){
    const gl=$("#gameList");
    gl.innerHTML="";
    const now=Date.now();
    GAMES.forEach(g=>{
      const d=document.createElement("div");
      d.className="card";
      d.innerHTML=`<h4>${g.name}</h4><div class="muted">${g.desc}</div>`;
      const btn=document.createElement("button");
      btn.className="pillbtn";
      const until=state.gameCooldowns[g.key]||0;
      if(until>now){
        const secs=Math.ceil((until-now)/1000);
        btn.textContent="Bekle: "+secs+" sn";
        btn.disabled=true;
      }else{
        btn.textContent="Oyna";
        btn.onclick=()=>startGame(g.key);
      }
      d.appendChild(btn);
      gl.appendChild(d);
    });
  }

  const gameOverlay=$("#gameOverlay");
  const gameBody=$("#gameBody");
  const gameTitle=$("#gameTitle");
  let activeGameTimer = null; // YENƒ∞: Aktif oyun timerlarƒ±nƒ± temizlemek i√ßin

  $("#btnCloseGame").onclick=()=>{
    gameOverlay.style.display="none";
    gameBody.innerHTML="";
    // YENƒ∞: Oyundan √ßƒ±kƒ±lƒ±rsa zamanlayƒ±cƒ±larƒ± temizle
    if(activeGameTimer) clearInterval(activeGameTimer);
    activeGameTimer = null;
  };

  function setGameCooldown(key){
    const cfg=GAMES.find(x=>x.key===key);
    if(!cfg) return;
    state.gameCooldowns[key]=Date.now()+cfg.cooldown*1000;
    save();
    renderGames();
  }

  function startGame(key){
    // YENƒ∞: Yeni oyuna ba≈ülamadan eskisini temizle
    if(activeGameTimer) clearInterval(activeGameTimer);
    activeGameTimer = null;
    
    if(key==="reflex") runReflexGame();
    else if(key==="timing") runTimingGame();
    else if(key==="balloon") runBalloonGame();
    else if(key==="memory") runMemoryGame();
    else if(key==="sequence") runSequenceGame(); // YENƒ∞
  }

  function runReflexGame(){
    gameOverlay.style.display="flex";
    gameTitle.textContent="‚ö° Refleks Tƒ±kla";
    gameBody.innerHTML=`
      <div>(Zor) 8 saniye boyunca ye≈üil noktaya tƒ±kla.</div>
      <div class="gameTarget" id="reflexArea"></div>
      <div style="margin-top:6px;">Skor: <span id="refScore">0</span> ¬∑ Kalan: <span id="refTime">8</span>s</div>`;
    const area=$("#reflexArea");
    const dot=document.createElement("div");
    dot.className="gameDot";
    dot.textContent="‚Ä¢";
    area.appendChild(dot);
    let score=0, time=8; // ZORLA≈ûTIRILDI: 10sn -> 8sn
    const moveDot=()=>{
      const r=area.getBoundingClientRect();
      const x=Math.random()*(r.width-40);
      const y=Math.random()*(r.height-40);
      dot.style.left=x+"px";
      dot.style.top=y+"px";
    };
    moveDot();
    dot.onclick=()=>{
      if(time > 0) { // Sadece s√ºre varken √ßalƒ±≈ü
        score++;
        $("#refScore").textContent=score;
        moveDot();
      }
    };
    activeGameTimer=setInterval(()=>{ // YENƒ∞: Timer'ƒ± deƒüi≈ükene ata
      time--;
      $("#refTime").textContent=time;
      if(time<=0){
        clearInterval(activeGameTimer);
        activeGameTimer = null;
        dot.onclick=null;
        finishReflex(score);
      }
    },1000);
  }

  function finishReflex(score){
    const xp=10+score*4;
    const coins=5+Math.round(score*2);
    levelCheck(xp);
    state.coins+=coins;
    $("#coins").textContent=state.coins;
    updateBars();
    save();
    setGameCooldown("reflex");
    showToast("Refleks skor: "+score+" (+"+xp+" XP, +"+coins+"‚¶ø)");
    setTimeout(()=>{
      gameOverlay.style.display="none";
      gameBody.innerHTML="";
    },600);
  }

  function runTimingGame(){
    gameOverlay.style.display="flex";
    gameTitle.textContent="üéØ Zamanlama";
    gameBody.innerHTML=`
      <div>(Zor) Bar %100'e en yakƒ±nken "DUR" butonuna bas.</div>
      <div class="gameBarOuter"><div class="gameBarInner" id="timBar"></div></div>
      <div style="margin-top:4px;">Deƒüer: <span id="timVal">0</span>%</div>
      <button class="mbtn" id="btnStop">DUR</button>`;
    const bar=$("#timBar");
    const valTxt=$("#timVal");
    let val=0, dir=1, running=true;
    activeGameTimer=setInterval(()=>{ // YENƒ∞: Timer'ƒ± deƒüi≈ükene ata
      if(!running) return;
      val+=dir*6; // ZORLA≈ûTIRILDI: Hƒ±z 4 -> 6
      if(val>=100){val=100; dir=-1;}
      if(val<=0){val=0; dir=1;}
      bar.style.width=val+"%";
      valTxt.textContent=val;
    },60); // ZORLA≈ûTIRILDI: Aralƒ±k 80 -> 60
    $("#btnStop").onclick=()=>{
      running=false;
      clearInterval(activeGameTimer);
      activeGameTimer = null;
      finishTiming(val);
    };
  }

  function finishTiming(val){
    const diff=Math.abs(100-val);
    const score=Math.max(0,100-diff);
    const xp=12+Math.round(score*0.6);
    const coins=6+Math.round(score*0.25);
    levelCheck(xp);
    state.coins+=coins;
    $("#coins").textContent=state.coins;
    updateBars();
    save();
    setGameCooldown("timing");
    showToast("Zamanlama skor: "+score+" (+"+xp+" XP, +"+coins+"‚¶ø)");
    setTimeout(()=>{
      gameOverlay.style.display="none";
      gameBody.innerHTML="";
    },700);
  }

  function runBalloonGame(){
    gameOverlay.style.display="flex";
    gameTitle.textContent="üéà Balon Patlat";
    gameBody.innerHTML=`
      <div>(Zor) Yukarƒ± √ßƒ±kan balonlara tƒ±kla. S√ºre: 15 sn.</div>
      <div class="gameTarget" id="balArea"></div>
      <div style="margin-top:6px;">Skor: <span id="balScore">0</span> ¬∑ Kalan: <span id="balTime">15</span>s</div>`;
    const area=$("#balArea");
    let score=0, time=15;
    const balloons=[];
    let spawnTimer=null; // YENƒ∞: Timerlarƒ± temizlemek i√ßin
    let loopId=null;
    
    function spawnBalloon(){
      const b=document.createElement("div");
      b.className="gameDot";
      b.style.background="#3b82f6";
      b.textContent=Math.random()>0.5?"üéà":"‚≠ê";
      const r=area.getBoundingClientRect();
      const x=Math.random()*(r.width-40);
      b.style.left=x+"px";
      b.style.top=(r.height-10)+"px";
      area.appendChild(b);
      // ZORLA≈ûTIRILDI: Hƒ±z artƒ±rƒ±ldƒ±
      const obj={el:b,y:r.height-10,speed:70+Math.random()*70};
      balloons.push(obj);
      b.onclick=()=>{
        score++;
        $("#balScore").textContent=score;
        if(b.parentNode===area) area.removeChild(b);
        const idx=balloons.indexOf(obj);
        if(idx>=0) balloons.splice(idx,1);
      };
    }
    let lastTs=null;
    function loop(ts){
      if(!lastTs) lastTs=ts;
      const dt=(ts-lastTs)/1000;
      lastTs=ts;
      balloons.forEach(obj=>{
        obj.y-=obj.speed*dt;
        obj.el.style.top=obj.y+"px";
      });
      for(let i=balloons.length-1;i>=0;i--){
        if(balloons[i].y<-40){
          const el=balloons[i].el;
          if(el.parentNode===area) area.removeChild(el);
          balloons.splice(i,1);
        }
      }
      if(time>0) loopId = requestAnimationFrame(loop);
    }
    spawnTimer=setInterval(()=>{ // YENƒ∞: Timer'ƒ± deƒüi≈ükene ata
      if(time>0) spawnBalloon();
    },450); // ZORLA≈ûTIRILDI: Sƒ±klƒ±k 500ms -> 450ms
    
    activeGameTimer=setInterval(()=>{ // YENƒ∞: Timer'ƒ± deƒüi≈ükene ata
      time--;
      $("#balTime").textContent=time;
      if(time<=0){
        clearInterval(activeGameTimer);
        activeGameTimer = null;
        clearInterval(spawnTimer);
        cancelAnimationFrame(loopId);
        finishBalloon(score,area,balloons);
      }
    },1000);
    loopId = requestAnimationFrame(loop);
  }

  function finishBalloon(score,area,balloons){
    balloons.forEach(b=>{ if(b.el.parentNode===area) area.removeChild(b.el); });
    const xp=8+score*3;
    const coins=4+Math.round(score*1.5);
    levelCheck(xp);
    state.coins+=coins;
    $("#coins").textContent=state.coins;
    updateBars();
    save();
    setGameCooldown("balloon");
    showToast("Balon skor: "+score+" (+"+xp+" XP, +"+coins+"‚¶ø)");
    setTimeout(()=>{
      gameOverlay.style.display="none";
      gameBody.innerHTML="";
    },700);
  }

  function runMemoryGame(){
    gameOverlay.style.display="flex";
    gameTitle.textContent="üß† Hafƒ±za Kartlarƒ±";
    const icons=["üê∂","üê±","üê∞","ü¶ä","üêº","üêπ"];
    const deck=[...icons,...icons].sort(()=>Math.random()-0.5);
    gameBody.innerHTML=`
      <div>ƒ∞ki aynƒ± ikonu bul. T√ºm √ßiftleri a√ßƒ±nca √∂d√ºl alƒ±yorsun.</div>
      <div class="memGrid" id="memGrid"></div>
      <div style="margin-top:6px;">Bulunan √ßift: <span id="memPairs">0</span> / ${icons.length}</div>`;
    const grid=$("#memGrid");
    let first=null, lock=false, pairs=0;
    deck.forEach((icon,idx)=>{
      const card=document.createElement("div");
      card.className="memCard";
      card.dataset.icon=icon;
      card.dataset.index=idx;
      card.textContent="Ôºü";
      card.onclick=()=>{
        if(lock || card.classList.contains("matched") || card===first) return;
        revealCard(card);
        if(!first){
          first=card;
        }else{
          lock=true;
          if(first.dataset.icon===card.dataset.icon){
            setTimeout(()=>{
              first.classList.add("matched");
              card.classList.add("matched");
              pairs++;
              $("#memPairs").textContent=pairs;
              lock=false;
              first=null;
              if(pairs===icons.length){
                finishMemory(pairs);
              }
            },350);
          }else{
            setTimeout(()=>{
              hideCard(first);
              hideCard(card);
              lock=false;
              first=null;
            },550);
          }
        }
      };
      grid.appendChild(card);
    });
  }

  function revealCard(card){
    card.classList.add("revealed");
    card.textContent=card.dataset.icon;
  }
  function hideCard(card){
    card.classList.remove("revealed");
    card.textContent="Ôºü";
  }

  function finishMemory(pairs){
    const xp=35+pairs*4;
    const coins=15+pairs*2;
    levelCheck(xp);
    state.coins+=coins;
    $("#coins").textContent=state.coins;
    updateBars();
    save();
    setGameCooldown("memory");
    showToast("Hafƒ±za tamam! (+"+xp+" XP, +"+coins+"‚¶ø)");
    setTimeout(()=>{
      gameOverlay.style.display="none";
      gameBody.innerHTML="";
    },900);
  }

  // YENƒ∞: Sƒ±ralƒ± Tƒ±kla Oyunu
  function runSequenceGame(){
    gameOverlay.style.display="flex";
    gameTitle.textContent="üî¢ Sƒ±ralƒ± Tƒ±kla";
    gameBody.innerHTML=`
      <div>Sƒ±rayƒ± izle ve tekrarla.</div>
      <div class="seqGrid" id="seqGrid"></div>
      <div style="margin-top:6px;">Tur: <span id="seqLevel">1</span> ¬∑ Skor: <span id="seqScore">0</span></div>
      <div id="seqStatus" class="muted" style="margin-top:4px; height: 1.2em;">Sƒ±rayƒ± izle...</div>
    `;
    const grid=$("#seqGrid");
    const status=$("#seqStatus");
    const btns=[];
    for(let i=0;i<9;i++){
      const btn=document.createElement("button");
      btn.className="seqBtn";
      btn.dataset.index=i;
      btn.textContent=i+1;
      grid.appendChild(btn);
      btns.push(btn);
    }
    
    let sequence = [];
    let playerSequence = [];
    let level = 0;
    let score = 0;
    let playerTurn = false;
    
    function setPlayerTurn(isTurn){
      playerTurn = isTurn;
      status.textContent = isTurn ? "Sƒ±ra sende!" : "Sƒ±rayƒ± izle...";
      btns.forEach(b=>b.classList.toggle("disabled", !isTurn));
    }
    
    function flashButton(index){
      const btn=btns[index];
      btn.classList.add("lit");
      setTimeout(()=>btn.classList.remove("lit"), 350);
    }
    
    async function playSequence(){
      setPlayerTurn(false);
      await new Promise(r=>setTimeout(r,500));
      for(const index of sequence){
        flashButton(index);
        await new Promise(r=>setTimeout(r,500));
      }
      setPlayerTurn(true);
      playerSequence = [];
    }
    
    function nextLevel(){
      level++;
      $("#seqLevel").textContent=level;
      sequence.push(Math.floor(Math.random()*9));
      playSequence();
    }
    
    btns.forEach(btn=>{
      btn.onclick=()=>{
        if(!playerTurn) return;
        const index = parseInt(btn.dataset.index);
        flashButton(index);
        playerSequence.push(index);
        
        const i = playerSequence.length - 1;
        if(playerSequence[i] !== sequence[i]){
          // Hata
          setPlayerTurn(false);
          status.textContent = "Yanlƒ±≈ü sƒ±ra! Oyun bitti.";
          finishSequence(score);
          return;
        }
        
        score += 5;
        $("#seqScore").textContent = score;
        
        if(playerSequence.length === sequence.length){
          // Tur tamam
          score += 20;
          $("#seqScore").textContent = score;
          nextLevel();
        }
      }
    });
    
    nextLevel();
  }

  function finishSequence(score){
    const xp=20+Math.round(score*0.5);
    const coins=10+Math.round(score*0.2);
    levelCheck(xp);
    state.coins+=coins;
    $("#coins").textContent=state.coins;
    updateBars();
    save();
    setGameCooldown("sequence");
    showToast("Sƒ±ra skoru: "+score+" (+"+xp+" XP, +"+coins+"‚¶ø)");
    setTimeout(()=>{
      gameOverlay.style.display="none";
      gameBody.innerHTML="";
    },1200);
  }

  // --- MODAL FONKSƒ∞YONLARI ---

  // !!!!! √ñNEMLƒ∞ HATA D√úZELTMESƒ∞ !!!!!
  // Orijinal kodda 'build' fonksiyonu 'appendChild'dan √ñNCE √ßaƒürƒ±lƒ±yordu.
  // Bu, 'build' i√ßindeki $(...) se√ßicilerinin ba≈üarƒ±sƒ±z olmasƒ±na ve kodun √ß√∂kmesine neden oluyordu.
  // D√ºzeltilmi≈ü sƒ±rada: √ñnce kart DOM'a eklenir, sonra 'build' √ßaƒürƒ±lƒ±r.
  function openModal(build){
    const overlay=$("#modalOverlay");
    overlay.innerHTML=""; // √ñnce temizle
    const card=document.createElement("div");
    card.className="modal";
    overlay.appendChild(card); // 1. KARTI EKLE
    overlay.style.display="grid"; // 2. G√ñR√úN√úR YAP
    build(card,overlay); // 3. ≈ûƒ∞MDƒ∞ ƒ∞√áƒ∞Nƒ∞ DOLDUR (artƒ±k se√ßiciler √ßalƒ±≈üƒ±r)
  }

  // YENƒ∞: Se√ßim kilidi mantƒ±ƒüƒ± eklendi
  $("#btnChangePet").onclick=()=>openPetSelector(false);

  function openPetSelector(isFirstTime = false){
    openModal((card,overlay)=>{
      card.innerHTML=`
        <div class="mrow">
          <h3>${isFirstTime ? "Yeni Evcil Hayvan" : "Hayvan Deƒüi≈ütir"}</h3>
          <button class="mbtn" id="closeSel">Kapat</button>
        </div>
        ${isFirstTime ? "<div class='muted' style='margin-bottom:8px'>Oyununa ba≈ülamak i√ßin bir t√ºr se√ß ve isim ver. Bu se√ßim daha sonra deƒüi≈ütirilemez!</div>" : ""}
        <div class="choice" id="petChoices"></div>
        <div class="mrow" style="margin-top:8px;">
          <span>ƒ∞sim:</span>
          <input type="text" id="petNameInput" value="${state.name}">
          <button class="mbtn" id="btnSelSave">Kaydet</button>
        </div>`;
      
      const closeBtn = $("#closeSel");
      closeBtn.onclick=()=>{overlay.style.display="none"; overlay.innerHTML="";};
      // ƒ∞lk se√ßimde kapatma butonu olmaz
      if(isFirstTime) closeBtn.style.display = "none";
      
      const pc=$("#petChoices");
      Object.entries(SPECIES).forEach(([key,val])=>{
        const d=document.createElement("div");
        d.className="opt";
        d.dataset.key=key;
        d.innerHTML=`<span class="emo">${val.emo[0]}</span><span>${val.name}</span>`;
        if(key===state.species) d.classList.add("active");
        d.onclick=()=>{
          $$("#petChoices .opt").forEach(o=>o.classList.remove("active"));
          d.classList.add("active");
        };
        pc.appendChild(d);
      });

      $("#btnSelSave").onclick=()=>{
        const active=$("#petChoices .opt.active");
        const key=active?active.dataset.key:state.species;
        const nm=$("#petNameInput").value.trim()||"Dost";
        state.species=key;
        state.name=nm;
        state.seenSelector=true; // YENƒ∞: Se√ßim yapƒ±ldƒ±
        
        renderPet();
        renderActivities();
        renderInventory();
        renderShop();
        save();
        
        // YENƒ∞: Se√ßim yapƒ±ldƒ±ƒüƒ± i√ßin deƒüi≈ütir butonunu gizle
        $("#btnChangePet").style.display = "none";
        
        overlay.style.display="none"; overlay.innerHTML="";
      };
    });
  }

  $("#gear").onclick=()=>openSettings();
  function openSettings(){
    openModal((card,overlay)=>{
      card.innerHTML=`
        <div class="mrow">
          <h3>Ayarlar</h3>
          <button class="mbtn" id="closeSet">Kapat</button>
        </div>
        <div class="card" style="background:#111827;border-color:#1f2937;margin-top:6px;">
          <h4>Oyun Ayarlarƒ±</h4>
          <div class="muted">Rahat modda a√ßlƒ±k/azalma daha yava≈ü i≈üler.</div>
          <div class="mrow" style="margin-top:6px;">
            <span>Rahat mod:</span>
            <button class="mbtn" id="btnSlowMode"></button>
          </div>
          <div class="muted" style="margin-top:10px;">Hayvan se√ßiminizi deƒüi≈ütirmek veya ba≈ütan ba≈ülamak i√ßin ilerlemeyi silin.</div>
          <div class="mrow" style="margin-top:6px;">
            <span>Kaydƒ± sƒ±fƒ±rla:</span>
            <button class="mbtn" id="btnResetSave" style="background:#b91c1c;border-color:#f87171;">T√ºm ilerlemeyi sil</button>
          </div>
        </div>
        <div class="card" style="background:#111827;border-color:#1f2937;margin-top:8px;">
          <h4>Bilgi</h4>
          <div class="muted">Bu s√ºr√ºm: t√ºr se√ßimi (kilitli), √ßoklu animasyonlu aktiviteler (cooldown'lu), t√ºrlere √∂zel kƒ±yafetler ve 5 mini oyun (Refleks, Zamanlama, Balon, Hafƒ±za, Sƒ±ralƒ± Tƒ±kla) i√ßerir. √áevrimdƒ±≈üƒ± ilerleme desteklenir.</div>
        </div>`;
      $("#closeSet").onclick=()=>{overlay.style.display="none"; overlay.innerHTML="";};
      
      const btnSlow=$("#btnSlowMode");
      const refreshSlow=()=>{
        btnSlow.textContent = state.slowMode ? "A√ßƒ±k" : "Kapalƒ±";
      };
      refreshSlow();
      btnSlow.onclick=()=>{
        state.slowMode=!state.slowMode;
        refreshSlow();
        save();
      };
      
      $("#btnResetSave").onclick=()=>{
        if(confirm("T√ºm ilerlemeyi silmek istediƒüinize emin misiniz? Hayvan se√ßiminiz dahil her ≈üey sƒ±fƒ±rlanacak.")){
          localStorage.removeItem(SAVE_KEY);
          location.reload();
        }
      };
    });
  }

  // --- SEKME VE ANA D√ñNG√úLER ---

  $$("#tabs .tabbtn").forEach(btn=>{
    btn.onclick=()=>{
      $$("#tabs .tabbtn").forEach(b=>b.classList.toggle("active",b===btn));
      const id=btn.dataset.tab;
      $$("#screens .screen").forEach(sc=>sc.classList.toggle("active",sc.id===id));
      if(id==="inventory") renderInventory();
      if(id==="shop") renderShop();
      if(id==="games") renderGames();
      if(id==="home") renderActivities(); // YENƒ∞: Cooldown'larƒ± yenilemek i√ßin
    };
  });

  // Ana oyun d√∂ng√ºs√º (Stat d√º≈ü√º≈ü√º)
  setInterval(()=>{
    const factor = state.slowMode ? 0.4 : 1;
    state.hunger=clamp(state.hunger-0.5*factor,0,100);
    state.fun   =clamp(state.fun-0.3*factor,0,100);
    state.energy=clamp(state.energy+0.3*factor,0,100); // Enerji yava≈ü√ßa dolar
    updateBars();
    save();
  }, TICK_INTERVAL * 1000); // 15 saniye

  // Cooldown'larƒ± g√ºncellemek i√ßin periyodik render
  setInterval(()=>{ 
    renderGames(); 
    // Sadece "home" sekmesi a√ßƒ±ksa render et (performans)
    if($("#home").classList.contains("active")) {
      renderActivities(); 
    }
  }, 1000); // 1 saniyede bir

  $("#petFace").onclick=()=>{
    // "Sev" aktivitesinin kƒ±sa bir versiyonu, ama cooldown'a takƒ±lmƒ±yor
    state.bond=clamp(state.bond+2,0,100); // Daha az baƒü
    state.fun =clamp(state.fun+1,0,100); // Daha az ne≈üe
    levelCheck(2); // Daha az XP
    updateBars();
    playActivityAnimation("bounce");
    save();
  };

  // --- BA≈ûLAT ---
  load();
  $("#coins").textContent=state.coins;
  renderPet();
  updateBars();
  renderActivities();
  renderGames();
  
  // YENƒ∞: ƒ∞lk √ßalƒ±≈ütƒ±rma ve se√ßim kilidi
  if(!state.seenSelector){
    openPetSelector(true); // true = Bu ilk se√ßim, kilitlenecek
  } else {
    $("#btnChangePet").style.display = "none"; // √ñnceden se√ßim yapƒ±ldƒ±ysa butonu gizle
  }
})();
</script>
</body>
</html>